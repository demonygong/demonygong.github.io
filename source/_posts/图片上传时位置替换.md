---
title: 图片上传时位置替换
date: 2020-06-28 14:54:10
tags:
- iview
- upload
categories:
- Vue
- iview
---

&ensp;&ensp;&ensp;&ensp;针对上传图片时替换位置，大多数情况下的想法是把图片删除再重新上传，得到想要的顺序就行。然而，当提出上传回显后可以直接替换图片位置，仔细想了一下，貌似也是很合理的需求。
&ensp;&ensp;&ensp;&ensp;所以就有了接下来的爬坑之路（记载以便回顾）。。
<!--more-->

### 分析筛选
既然有要加的需求，那么就满足，加。
因为项目用的是iview，所以就去看了iview官方上传图片的组件，最后发现 没有直接替换图片位置的属性或者方法，这就有点头大了。
从网上百度的，发现element貌似有这个功能（没有实践），但是项目方面是iview，要是替换组件的话改动也有点大（麻烦）。所以就考虑再找找看，这个可以当成备用方案。
最后，找到了一种折中的方案，在原有的基础上加入一些方法（参考：[div拖拽](https://www.cnblogs.com/xuxiaoxia/p/8405076.html)）。

### 代码块

#### 图片上传（iview组件）
这点可直接照搬iview，根据需要增删属性、方法
```
    <Upload
        ref="uploads"
        :show-upload-list="false"
        :default-file-list="DefaultLists"
        :on-success="handleSuccesses"
        :format="['jpg','jpeg','png']"
        :max-size="10240"
        :on-format-error="handleFormatErrors"
        :on-exceeded-size="handleMaxSizes"
        :before-upload="handleBeforeUploads"
        type="drag"
        name="image"
        :action="UploadAction"
        style="display: inline-block;width:160px;"
        >
        <div style="width: 160px;height:100px;line-height: 100px;">
            <Icon type="ios-camera" size="20"></Icon>
        </div>
    </Upload>
```

#### 图片回显
实际就一个简单回显，不过在图片外层加了个div。（__以下几个方法放入img标签中无效，需放入div中__）
```
    <template>
        <div
            draggable="true"
            @dragstart="handleDragStart($event, item)"
            @dragover.prevent="handleDragOver($event, item)"
            @dragenter="handleDragEnter($event, item)" 
            @dragend="handleDragEnd($event, item)">

            <img :src="item.url"  />
            <div class="demo-upload-list-cover">
                <Icon type="ios-trash-outline" @click.native="handleRemoves(item)"></Icon>
            </div>
        </div>
    </template>
```
#### js部分
加入上面div中定义的四个方法，至此 就已经实现了图片拖拽的效果（发现挺简单的）。
```
    handleDragStart(e,item){
        this.dragging = item;
    },
    handleDragEnd(e,item){
        this.dragging = null
    },
    //首先把div变成可以放置的元素，即重写dragenter/dragover
    handleDragOver(e) {
        e.dataTransfer.dropEffect = 'move'// e.dataTransfer.dropEffect="move";//在dragenter中针对放置目标来设置!
    },
    handleDragEnter(e,item){
        e.dataTransfer.effectAllowed = "move"//为需要移动的元素设置dragstart事件
        if(item === this.dragging){
            return
        }
        const newItems = [...this.items]
        console.log(newItems)
        const src = newItems.indexOf(this.dragging)
        const dst = newItems.indexOf(item)
 
        newItems.splice(dst, 0, ...newItems.splice(src, 1))
 
        this.items = newItems
    }
```

### 图片替换位置后删除
上面一完成还以为整个就改完了，奈何是我想多了。
图片替换位置后，再点击删除，发现没有任何动静，原有正常的删除也不生效了。改代码的心塞。 
在原先的删除方法中仔细摸索修改，最终解决了问题。


```
handleRemoves(file) {
      this.$refs.uploads.fileList.splice(this.$refs.uploads.fileList.indexOf(file), 1);
      this.formItem.imgs_arr = []  //中转
      this.uploadLists.forEach((el, index) =>{
          this.formItem.imgs_arr.push(el.url.split('img/')[1])
      })
      var imgs_index = 0    // 获取点击删除图的索引
      if (this.formItem.imgs_arr) {
        for(let i = 0; i < this.formItem.imgs_arr.length; i++){
            if(file!=undefined){
                if(file.url == config.front_url + "uploads/img/" + this.formItem.imgs_arr[i]){
                    imgs_index = i;
                    break;
                }
            }
        }
        // 通过splice方法删除指定下标
        this.formItem.imgs_arr.splice(imgs_index, 1);
        // 接收字段
        this.formItem.imgs = this.formItem.imgs_arr;
      }
        
        // 图片回显
        this.uploadLists = []
        var lists = []
        if(this.formItem.imgs.length>0){
            for (var i = 0; i < this.formItem.imgs.length; i++) {
                lists  = {
                    name: "",
                    url: config.front_url + "uploads/img/" + this.formItem.imgs[i],
                    status: 'finished' // 判断是否显示
                };
                this.uploadLists.push(lists)
            }
        }
    },
```
这里整个改过之后的删除代码放过来了，主要是和定义的字段一一准确对应，其中逻辑可供参考。

### 图片删除后再上传回显
这里发现删除后再上传，显示成功但是无回显。
```
    handleSuccesses(res, file) {
      if (!this.formItem.imgs) {
        this.formItem.imgs = [];
      }
      file.url = config.front_url + "uploads/img/" + res.data.fileName;
      this.formItem.imgs.push(res.data.fileName);
  
        // 上传手动回显
        this.uploadLists = []
        var lists = []
        for (var i = 0; i < this.formItem.imgs.length; i++) {
            lists  = {
                name: "",
                url: config.front_url + "uploads/img/" + this.formItem.imgs[i],
                status: 'finished'
            };
            this.uploadLists.push(lists)
        }
    },
```

### 图片只替换位置
删除解决掉后，发现单独只替换图片位置再保存的时候，实际图片位置未替换。需求提的就是这一点，这个肯定是要完善的。
```
    handleDragEnter(e,item){
        ...

        // 单独替换位置时保存图片及相应位置
        this.formItem.imgs_arr = []
        this.uploadLists.forEach((el, index) =>{
            this.formItem.imgs_arr.push(el.url.split('img/')[1])
        })
        this.formItem.imgs = this.formItem.imgs_arr;
    }
```
这个操作起来也简单，就是在替换的时候重新赋值回显加后台要接收的。
OK，至此问题解决。

### 实现效果

![funnel](/img/up_pic1.jpg)
![funnel](/img/up_pic2.jpg)
![funnel](/img/up_pic3.jpg)

### 回顾
通过div拖拽来实现图片的拖拽效果。**在所需要拖拽的范围外加一层div**。
**主要就是拖拽方法、以及删除方法中相应的参数变化和接收，对应准确后可正常操作**。